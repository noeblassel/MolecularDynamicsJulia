using Statistics

include("../molly/MollyExtend.jl")
    
T = 2.509902891886945
Npd=10
eq_steps=3000
samp_steps=100_000
dt = 5e-3
filename=ARGS[1]


ρs=[0.04917981483661091, 0.04917981483661091, 0.04917981483661091, 0.10018276471122438, 0.15135009561385449, 0.20074808890583293, 0.246750866782777, 0.28846180545550515, 0.3256896251823253, 0.3587092905919198, 0.3880109560223745, 0.41410868577948706, 0.4374986116932711, 0.458605135690606, 0.4777749523033087, 0.49530693612777293, 0.511434209349186, 0.5263480517092399, 0.5402158329819156, 0.5531630804976978, 0.5652973891112889, 0.5767203761854626, 0.5875037716233532, 0.5977193053280956, 0.6074327297108963, 0.6166380672798274, 0.625484755333086, 0.633913018951393, 0.6419826330540274, 0.6497533725602679, 0.657165462550836, 0.6643982277835674, 0.6712723435006264, 0.677967134459849, 0.6844826006612353, 0.6907589671855064, 0.6967962340326627, 0.7027139510412611, 0.7083925683727447, 0.7140114107849496, 0.7193911535200391, 0.7246513464165711, 0.7297919894745458, 0.7348130826939627, 0.7397146260748221, 0.7444966196171239, 0.7491590633208683, 0.7537019571860551, 0.7581850761319632, 0.7625486452393136, 0.7668524394273853, 0.7710366837768995, 0.775101378287856, 0.7791660727988127, 0.7831112174712116, 0.7869965872243319, 0.7908221820581735, 0.7945282270534574, 0.7982342720487414, 0.8018207672054677, 0.8054072623621942, 0.808874207680363, 0.8123411529985319, 0.815688548478143, 0.8190359439577546, 0.8223235645180871, 0.8255514101591407, 0.8287792558001946, 0.8318875516026908, 0.8349958474051872, 0.8380443682884045, 0.8410331142523433, 0.8440218602162818, 0.8469508312609418, 0.8498200273863229, 0.8526892235117041, 0.8554986447178063, 0.8583080659239088, 0.8610577122107324, 0.8637475835782771, 0.8664374549458219, 0.8691273263133666, 0.8716976478423539, 0.8743277442906201, 0.8768980658196073, 0.8794086124293158, 0.8819191590390243, 0.884369930729454, 0.8868207024198836, 0.8892714741103134, 0.8916624708814643, 0.8940534676526153, 0.8963846895044874, 0.8987159113563596, 0.9009873582889529, 0.9033185801408251, 0.9055302521541397, 0.9078016990867331, 0.9100133711000479, 0.9122250431133624, 0.9143769402073983, 0.9165288373014341, 0.91868073439547, 0.920772856570227, 0.922864978744984, 0.9249571009197411, 0.9269894481752193, 0.9290217954306977, 0.9310541426861759, 0.9330864899416542, 0.9350590622778537, 0.9370316346140534, 0.939004206950253, 0.9409170043671735, 0.9428895767033733, 0.944802374120294, 0.9466553966179359, 0.9485681940348566, 0.9504212165324988, 0.9522742390301405, 0.9541272615277827, 0.9559205091061458, 0.9577735316037878, 0.9595667791821509, 0.9613002518412355, 0.9630934994195987, 0.964826972078683, 0.9666202196570463, 0.9683536923161308, 0.9700273900559363, 0.9717608627150209, 0.9734345604548263, 0.975168033113911, 0.9768417308537165, 0.9784556536742434, 0.9801293514140491, 0.9818030491538547, 0.9834169719743817, 0.9850308947949085, 0.9866448176154354, 0.9882587404359623, 0.9898128883372105, 0.9914268111577371, 0.9929809590589854, 0.9945351069602335, 0.9960892548614818, 0.9976434027627297, 0.999137775744699, 1.000691923645947, 1.0021862966279165, 1.003680669609886, 1.005175042591855, 1.0066694155738243, 1.0081637885557937, 1.0095983866184843, 1.0110927596004537, 1.0125273576631442, 1.0139619557258348, 1.0153965537885254, 1.0168311518512159, 1.0182657499139067, 1.0196405730573184, 1.0210751711200088, 1.0224499942634206, 1.0238248174068325, 1.0251996405502442, 1.026574463693656, 1.027949286837068, 1.0293241099804795, 1.0306989331238914, 1.0320139813480247, 1.0333888044914363, 1.0347038527155692, 1.0360189009397023, 1.0373339491638354, 1.0386489973879682, 1.0399640456121013, 1.0412790938362344, 1.0425343671410885, 1.0438494153652216, 1.0451046886700759, 1.04635996197493, 1.0476750101990633, 1.0489302835039174, 1.0501855568087717, 1.0514408301136258, 1.0526363284992013, 1.0538916018040556, 1.05514687510891, 1.0563423734944852, 1.0575976467993395, 1.058793145184915, 1.0599886435704906, 1.061184141956066, 1.0623796403416412, 1.0635751387272168, 1.0647706371127923, 1.0659661354983678, 1.0671616338839434, 1.06829735735024, 1.0694928557358157, 1.070628579202112]

N = Npd^3
r_c=4.0

atoms = [Atom(σ = 1.0, ϵ = 1.0, mass = 1.0) for i in 1:N]

for ρ in ρs
    
    L = (N / ρ)^(1 // 3)
    
    box_size = SVector(L, L, L)
    
    coords = place_atoms_on_lattice(Npd, box_size)
    
    velocities = [reduced_velocity_lj(T,atoms[i].mass) for i in 1:N]
    
    inter = LennardJones(cutoff = DistanceCutoff(r_c), nl_only = true, force_units = NoUnits, energy_units = NoUnits)
    
    nf=nothing

    if L>3*r_c
        nf = CellListMapNeighborFinder(nb_matrix = trues(N, N), dist_cutoff = r_c,unit_cell=box_size)   
    else
        nf=DistanceNeighborFinder(dist_cutoff=r_c)
    end

    γ = 1.0
 
    
    simulator = LangevinTest(dt = dt,γ=γ,T=T)
    
    sys = System(atoms = atoms, coords = coords, velocities = deepcopy(velocities), pairwise_inters = (inter,), box_size = box_size, neighbor_finder = nf, force_units = NoUnits, energy_units = NoUnits)
    try 
        simulate!(sys, simulator, eq_steps)
        
        loggers = Dict(:pressure => PressureLoggerNVT(T,Float64, 1))

        sys = System(atoms = sys.atoms, coords = sys.coords, velocities = sys.velocities, pairwise_inters = (inter,), box_size = sys.box_size, neighbor_finder = sys.neighbor_finder, force_units = NoUnits, energy_units = NoUnits, loggers = loggers)
        
        simulate!(sys, simulator, samp_steps)

        if filename!="STDOUT"
        f=open(filename,"a")
        println(f,ρ," ", mean(sys.loggers[:pressure].pressures)," ",long_range_virial_correction(sys,sys.pairwise_inters[1])/(3L^3))
        close(f)
        else
            println(ρ," ", mean(sys.loggers[:pressure].pressures)," ",long_range_virial_correction(sys,sys.pairwise_inters[1])/(3L^3))
        end
    catch
        if filename!="STDOUT"
        f=open(filename,"a")
        println(f,ρ," :error")
        close(f)
        else
            println(ρ," :error")
        end
    end
end
